<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EMBERWING // CIRRUS x HAVEN</title>
<style>
  :root{
    --ink:#d7e3ff; --muted:rgba(215,227,255,.75); --dim:rgba(215,227,255,.45);
    --line:rgba(215,227,255,.16);
    --shadow:rgba(0,0,0,.45);
    --radius:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  html,body{height:100%; margin:0; overflow:hidden; background:#05070b; color:var(--ink);}
  canvas{position:fixed; inset:0; width:100%; height:100%; display:block;}

  #hud{position:fixed; inset:0; pointer-events:none; user-select:none; font-family:var(--sans);}
  .topbar{position:absolute; left:20px; right:20px; top:16px; display:flex; justify-content:space-between; gap:14px;}
  .brand,.panel,.status{
    padding:12px 14px; border-radius:var(--radius);
    background: linear-gradient(180deg, rgba(10,16,30,.42), rgba(10,16,30,.18));
    border:1px solid var(--line);
    box-shadow:0 18px 50px var(--shadow);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  }
  .brand{max-width:min(560px,52vw); display:flex; flex-direction:column; gap:6px;}
  .title{font-family:var(--mono); font-size:12px; text-transform:uppercase; display:flex; gap:10px; align-items:center; color:rgba(215,227,255,.92);}
  .dot{width:8px;height:8px;border-radius:999px; background:radial-gradient(circle at 30% 30%, rgba(255,210,160,1), rgba(255,190,120,.18)); box-shadow:0 0 14px rgba(255,190,120,.45);}
  .subtitle{font-size:12.5px; color:var(--muted);}
  .rightstack{display:flex; gap:12px; align-items:flex-start;}
  .panel{min-width:220px;}
  .hdr{font-family:var(--mono); font-size:11px; text-transform:uppercase; color:rgba(215,227,255,.82); display:flex; justify-content:space-between; margin-bottom:10px;}
  .badge{font-family:var(--mono); font-size:10px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:rgba(215,227,255,.82); background:rgba(10,16,30,.14);}
  .kv{display:grid; grid-template-columns:1fr auto; gap:8px 14px; align-items:center; font-size:12.5px;}
  .k{color:var(--dim); font-family:var(--mono); font-size:11px; text-transform:uppercase; letter-spacing:.5px;}
  .v{color:rgba(215,227,255,.94); font-family:var(--mono); font-size:12px; font-variant-numeric:tabular-nums;}

  .bottom{position:absolute; left:20px; right:20px; bottom:18px; display:flex; justify-content:flex-end;}
  .status{min-width:300px;}
  .big{font-family:var(--mono); font-size:12px; text-transform:uppercase; letter-spacing:.6px; display:flex; justify-content:space-between; margin-bottom:8px;}
  .bar{height:8px; border-radius:999px; background:rgba(215,227,255,.10); border:1px solid rgba(215,227,255,.14); overflow:hidden;}
  .fill{height:100%; width:50%; background:linear-gradient(90deg, rgba(120,210,255,.18), rgba(120,210,255,.78)); box-shadow:0 0 18px rgba(120,210,255,.35);}

  /* Monk mode: quieter, still readable */
  body.monk #hud .brand, body.monk #hud .panel, body.monk #hud .status{opacity:.62; filter:saturate(.85);}
  @media (max-width:980px){ .panel{display:none;} .brand{max-width:72vw;} }
</style>
</head>
<body class="monk">
<canvas id="c"></canvas>

<div id="hud" aria-hidden="true">
  <div class="topbar">
    <div class="brand">
      <div class="title"><span class="dot"></span> EMBERWING // CIRRUS x HAVEN <span class="badge" id="modeBadge">MONK</span></div>
      <div class="subtitle">Mission: <b>forward flight, steady hands.</b> <span id="missionLine">ゆっくりと。今ここ。</span></div>
    </div>
    <div class="rightstack">
      <div class="panel">
        <div class="hdr"><span>NAV</span><span class="badge" id="navBadge">MONK</span></div>
        <div class="kv">
          <div class="k">HDG</div><div class="v" id="hdg">000</div>
          <div class="k">ALT</div><div class="v" id="alt">00000</div>
          <div class="k">SPD</div><div class="v" id="spd">000</div>
          <div class="k">BOOST</div><div class="v" id="bst">OFF</div>
        </div>
      </div>
      <div class="panel">
        <div class="hdr"><span>MISSION</span><span class="badge" id="msBadge">FLOW</span></div>
        <div class="kv">
          <div class="k">GATES</div><div class="v" id="gates">0</div>
          <div class="k">MISS</div><div class="v" id="miss">0</div>
          <div class="k">SCORE</div><div class="v" id="score">0000</div>
          <div class="k">RANGE</div><div class="v" id="range">—</div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom">
    <div class="status">
      <div class="big"><span>WATTAGE</span><span class="badge" id="wattBadge">STEADY</span></div>
      <div class="bar"><div class="fill" id="wattFill"></div></div>
      <div class="kv" style="margin-top:10px">
        <div class="k">SIGNAL</div><div class="v" id="signal">CLEAN</div>
        <div class="k">LOCK</div><div class="v" id="lock">FORWARD</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha:false });

  const $ = (id)=>document.getElementById(id);
  const ui = {
    modeBadge:$("modeBadge"), missionLine:$("missionLine"),
    hdg:$("hdg"), alt:$("alt"), spd:$("spd"), bst:$("bst"),
    gates:$("gates"), miss:$("miss"), score:$("score"), range:$("range"),
    msBadge:$("msBadge"), navBadge:$("navBadge"),
    wattFill:$("wattFill"), wattBadge:$("wattBadge"), signal:$("signal"), lock:$("lock")
  };

  const TAU = Math.PI*2;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const fmt3=(n)=>String(Math.round(((n%360)+360)%360)).padStart(3,"0");
  const fmtAlt=(n)=>String(Math.round(n)).padStart(5,"0");
  const fmtSpd=(n)=>String(Math.round(n)).padStart(3,"0");

  const S = {
    t:0, dt:0,
    monk:true,
    keys:new Set(),
    pitch:0, roll:0,
    heading:0,
    altitude:38100,
    throttle:0.70,
    boost:false,
    speed:680,
    targetSpeed:680,
    driftX:0, driftY:0,
    gatesHit:0, gatesMiss:0, score:0,
    wattage:0.86, signalClean:1.0
  };

  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener("resize", resize, {passive:true});
  resize();

  function onKey(e, down){
    const k=e.code;
    if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space","CapsLock"].includes(k)) e.preventDefault();
    if (down) S.keys.add(k); else S.keys.delete(k);
    if (k==="Space") S.boost = down;
    if (down && k==="CapsLock"){
      S.monk = !S.monk;
      document.body.classList.toggle("monk", S.monk);
      ui.modeBadge.textContent = S.monk ? "MONK" : "LIVE";
      ui.navBadge.textContent = S.monk ? "MONK" : (S.boost ? "BOOST" : "NORM");
      ui.missionLine.textContent = S.monk ? "ゆっくりと。今ここ。" : "Ignition → Glide → Create.";
    }
  }
  addEventListener("keydown",(e)=>onKey(e,true),{passive:false});
  addEventListener("keyup",(e)=>onKey(e,false),{passive:false});

  // --- Sky + horizon ---
  function drawSky(){
    const w=canvas.width, h=canvas.height;
    const horizonY = h*0.52 + S.pitch*110;

    const sky = ctx.createLinearGradient(0,0,0,h);
    sky.addColorStop(0.00, "#05070b");
    sky.addColorStop(0.18, "#081427");
    sky.addColorStop(0.44, "#143a6a");
    sky.addColorStop(0.70, "#4e97c4");
    sky.addColorStop(1.00, "#0a2343");
    ctx.fillStyle = sky;
    ctx.fillRect(0,0,w,h);

    const glow = ctx.createRadialGradient(w*0.52,h*0.30,0, w*0.52,h*0.30, Math.max(w,h)*0.9);
    glow.addColorStop(0,"rgba(255,245,235,0.10)");
    glow.addColorStop(0.55,"rgba(185,235,255,0.08)");
    glow.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle = glow;
    ctx.fillRect(0,0,w,h);

    // horizon band + line (tilt with roll)
    ctx.save();
    ctx.translate(w*0.5, horizonY);
    ctx.rotate(-S.roll*0.55);

    const band = ctx.createLinearGradient(0,-70,0,110);
    band.addColorStop(0,"rgba(255,255,255,0)");
    band.addColorStop(0.45,"rgba(190,235,255,0.14)");
    band.addColorStop(0.60,"rgba(255,210,170,0.08)");
    band.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle = band;
    ctx.fillRect(-w,-90,w*2,220);

    ctx.globalAlpha = 0.30;
    ctx.strokeStyle = "rgba(215,227,255,0.78)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(-w,0); ctx.lineTo(w,0);
    ctx.stroke();

    ctx.restore();
    ctx.globalAlpha = 1;
  }

  // --- Speed streaks ---
  const flow = [];
  const FLOW = 620;
  for (let i=0;i<FLOW;i++) flow.push({x:Math.random()*2-1, y:Math.random()*2-1, z:Math.random(), s:Math.random()*1.2+0.2});

  function drawFlow(dt, forward){
    const w=canvas.width, h=canvas.height;
    const cx=w*0.5, cy=h*0.42;
    const sp = 1.05 + forward*2.25;

    for (const f of flow){
      f.z -= dt*(0.95 + (1-f.z)*3.7)*sp;
      if (f.z<=0.02){ f.x=Math.random()*2-1; f.y=Math.random()*2-1; f.z=1; f.s=Math.random()*1.2+0.2; }
      const p = 0.16/(f.z+0.06);
      const x = cx + (f.x + S.driftX*0.0011) * w * p;
      const y = cy + (f.y + S.driftY*0.0011) * h * p;
      const len = (12 + (1-f.z)*62) * sp;

      ctx.globalAlpha = (0.05 + (1-f.z)*0.26) * (S.monk?0.86:1);
      ctx.strokeStyle = "rgba(205,235,255,0.85)";
      ctx.lineWidth = Math.max(1, f.s*(1-f.z)*1.7);
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(x, y + len*p);
      ctx.stroke();
    }
    ctx.globalAlpha=1; ctx.lineWidth=1;
  }

  // --- Gates ---
  const gates=[];
  let gateTimer=0;
  function spawnGate(){
    const spread = S.monk ? 0.55 : 0.75;
    gates.push({ x:(Math.random()*2-1)*spread, y:(Math.random()*2-1)*spread*0.55, z:2200+Math.random()*1400, r:0.24+Math.random()*0.12, hit:false });
  }
  function updateGates(dt, forward){
    for (let i=gates.length-1;i>=0;i--){
      const g=gates[i];
      g.z -= dt*(forward*900 + 260);
      if (g.z < 120){
        if (!g.hit){ S.gatesMiss++; S.wattage=clamp(S.wattage-0.06,0,1); S.signalClean=clamp(S.signalClean-0.08,0,1); }
        gates.splice(i,1);
      }
    }
    gateTimer += dt*(S.monk?0.95:1);
    if (gateTimer>0.95){ gateTimer=0; if (gates.length<4) spawnGate(); }

    const aimX = clamp(S.roll*0.52,-1,1);
    const aimY = clamp(-S.pitch*0.72,-1,1);
    for (const g of gates){
      if (g.hit) continue;
      if (g.z<520 && g.z>200){
        const dx=aimX-g.x, dy=aimY-g.y;
        if (Math.hypot(dx,dy) < g.r*0.78){
          g.hit=true; S.gatesHit++; S.score += 28 + Math.round(70*S.signalClean);
          S.wattage=clamp(S.wattage+0.03,0,1); S.signalClean=clamp(S.signalClean+0.05,0,1);
        }
      }
    }
  }
  function drawGates(){
    const w=canvas.width, h=canvas.height;
    const cx=w*0.5, cy=h*0.44;
    for (const gt of gates){
      const p = 900/(gt.z+220);
      const x = cx + (gt.x + S.driftX*0.0006) * w * 0.55 * p;
      const y = cy + (gt.y + S.driftY*0.0006) * h * 0.45 * p;
      const r = Math.max(18, gt.r * Math.min(w,h) * 0.45 * p);

      const a = clamp(0.10 + (1200-gt.z)/1200*0.40, 0.10, 0.44) * (S.monk?0.82:1);
      ctx.globalAlpha = a;
      ctx.save();
      ctx.translate(x,y);
      ctx.globalCompositeOperation="lighter";

      const glow = ctx.createRadialGradient(0,0,r*0.65, 0,0,r*1.25);
      glow.addColorStop(0, "rgba(120,210,255,0)");
      glow.addColorStop(0.55,"rgba(120,210,255,0.28)");
      glow.addColorStop(1, "rgba(255,190,120,0)");
      ctx.fillStyle=glow;

      ctx.strokeStyle = gt.hit ? "rgba(120,255,190,0.80)" : "rgba(190,220,255,0.80)";
      ctx.lineWidth = Math.max(1, r*0.06);
      ctx.beginPath(); ctx.arc(0,0,r,0,TAU); ctx.stroke();
      ctx.beginPath(); ctx.arc(0,0,r*1.12,0,TAU); ctx.fill();

      ctx.globalCompositeOperation="source-over";
      ctx.restore();
      ctx.globalAlpha=1;
    }
  }

  // --- Attitude indicator overlay (real) ---
  function drawAttitude(){
    const w=canvas.width, h=canvas.height;
    const cx=w*0.5, cy=h*0.52;
    const radius = Math.min(w,h)*0.16;

    // convert pitch to pixels for ladder
    const pxPerDeg = radius*0.18; // tuned
    const pitchDeg = clamp(S.pitch * 18, -25, 25); // “feel degrees”
    const rollRad  = clamp(S.roll * 0.55, -0.75, 0.75);

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(-rollRad);

    // ladder group shifted by pitch
    ctx.translate(0, pitchDeg * pxPerDeg);

    // ladder lines every 5°
    ctx.globalAlpha = S.monk ? 0.28 : 0.34;
    ctx.strokeStyle = "rgba(220,245,255,0.85)";
    ctx.fillStyle   = "rgba(220,245,255,0.85)";
    ctx.lineWidth = 1;

    for (let d=-25; d<=25; d+=5){
      if (d===0) continue;
      const y = -d * pxPerDeg;
      const len = (d%10===0) ? radius*0.90 : radius*0.62;
      ctx.beginPath();
      ctx.moveTo(-len, y);
      ctx.lineTo( len, y);
      ctx.stroke();

      if (d%10===0){
        ctx.globalAlpha = (S.monk ? 0.22 : 0.28);
        ctx.font = "11px " + getComputedStyle(document.documentElement).getPropertyValue('--mono');
        ctx.textAlign="left"; ctx.textBaseline="middle";
        ctx.fillText(String(Math.abs(d)), len+8, y);
        ctx.textAlign="right";
        ctx.fillText(String(Math.abs(d)), -len-8, y);
        ctx.globalAlpha = S.monk ? 0.28 : 0.34;
      }
    }

    // 0-line bolder
    ctx.globalAlpha = S.monk ? 0.32 : 0.40;
    ctx.lineWidth = 1.4;
    ctx.beginPath();
    ctx.moveTo(-radius*0.92, 0);
    ctx.lineTo( radius*0.92, 0);
    ctx.stroke();

    ctx.restore();

    // roll arc (outside)
    ctx.save();
    ctx.translate(cx, cy);
    ctx.globalAlpha = S.monk ? 0.22 : 0.26;
    ctx.strokeStyle = "rgba(220,245,255,0.8)";
    ctx.lineWidth = 1;

    const arcR = radius*1.22;
    ctx.beginPath();
    ctx.arc(0,0,arcR, Math.PI*1.08, Math.PI*1.92);
    ctx.stroke();

    // tick marks
    const ticks = [-60,-45,-30,-20,-10,0,10,20,30,45,60];
    for (const t of ticks){
      const a = (t/180)*Math.PI;
      const ang = -a; // conventional
      const inner = arcR - (Math.abs(t)%30===0 ? 12 : 7);
      const outer = arcR + 2;
      ctx.beginPath();
      ctx.moveTo(Math.sin(ang)*inner, -Math.cos(ang)*inner);
      ctx.lineTo(Math.sin(ang)*outer, -Math.cos(ang)*outer);
      ctx.stroke();
    }

    // little roll pointer
    ctx.globalAlpha = S.monk ? 0.30 : 0.38;
    ctx.fillStyle = "rgba(255,210,160,0.75)";
    ctx.beginPath();
    ctx.moveTo(0, -arcR-10);
    ctx.lineTo(-6, -arcR+2);
    ctx.lineTo(6, -arcR+2);
    ctx.closePath();
    ctx.fill();

    ctx.restore();

    // fixed aircraft reference (center)
    ctx.globalAlpha = S.monk ? 0.30 : 0.36;
    ctx.strokeStyle = "rgba(220,245,255,0.85)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(cx-26, cy);
    ctx.lineTo(cx-6, cy);
    ctx.moveTo(cx+6, cy);
    ctx.lineTo(cx+26, cy);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  // --- Cockpit POV ---
  function drawCockpit(){
    const w=canvas.width, h=canvas.height;
    const cx=w*0.5, cy=h*0.56;

    // tiny vibration tied to speed/boost (disciplined)
    const vib = (S.boost ? 1 : 0) * 0.8 + (S.speed/1000)*0.25;
    const shake = (0.7 - S.wattage) * 0.9 + vib*0.25;

    // canopy frame mask
    ctx.save();
    ctx.translate(cx, cy);
    ctx.translate(Math.sin(S.t*18)*shake, Math.cos(S.t*22)*shake);

    ctx.globalAlpha = 0.92;
    ctx.fillStyle = "rgba(5,8,14,0.82)";
    ctx.beginPath();
    ctx.moveTo(-w*0.58, -h*0.12);
    ctx.quadraticCurveTo(0, -h*0.46, w*0.58, -h*0.12);
    ctx.lineTo(w*0.58, h*0.60);
    ctx.quadraticCurveTo(0, h*0.74, -w*0.58, h*0.60);
    ctx.closePath();
    ctx.fill();

    // cut out windshield (clear view)
    ctx.globalCompositeOperation = "destination-out";
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.moveTo(-w*0.46, -h*0.08);
    ctx.quadraticCurveTo(0, -h*0.36, w*0.46, -h*0.08);
    ctx.lineTo(w*0.36, h*0.44);
    ctx.quadraticCurveTo(0, h*0.56, -w*0.36, h*0.44);
    ctx.closePath();
    ctx.fill();

    ctx.globalCompositeOperation = "source-over";
    ctx.restore();

    // windshield glare
    const glare = ctx.createRadialGradient(w*0.62,h*0.18,0, w*0.62,h*0.18, Math.max(w,h)*0.65);
    glare.addColorStop(0,"rgba(255,245,235,0.10)");
    glare.addColorStop(0.35,"rgba(185,235,255,0.06)");
    glare.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle = glare;
    ctx.fillRect(0,0,w,h);

    // instrument panel (bottom)
    ctx.save();
    ctx.globalAlpha = 0.97;
    ctx.fillStyle = "rgba(8,12,20,0.92)";
    ctx.beginPath();
    ctx.moveTo(0, h*0.78);
    ctx.quadraticCurveTo(w*0.5, h*0.64, w, h*0.78);
    ctx.lineTo(w, h);
    ctx.lineTo(0, h);
    ctx.closePath();
    ctx.fill();

    // panel top edge highlight
    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = "rgba(215,227,255,0.7)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(0, h*0.78);
    ctx.quadraticCurveTo(w*0.5, h*0.64, w, h*0.78);
    ctx.stroke();

    // G1000-ish screens (minimal)
    ctx.globalAlpha = 0.92;
    ctx.fillStyle = "rgba(14,22,36,0.92)";
    const sw = w*0.22, sh = h*0.16, gap = w*0.03;
    const y  = h*0.80;
    ctx.fillRect(w*0.50 - gap/2 - sw, y, sw, sh);
    ctx.fillRect(w*0.50 + gap/2,       y, sw, sh);

    // soft screen glow
    ctx.globalAlpha = 0.28;
    ctx.fillStyle = "rgba(120,210,255,0.20)";
    ctx.fillRect(w*0.50 - gap/2 - sw, y, sw, sh);
    ctx.fillRect(w*0.50 + gap/2,       y, sw, sh);

    ctx.restore();
    ctx.globalAlpha = 1;
  }

  function updateFlight(dt){
    const up=S.keys.has("ArrowUp"), dn=S.keys.has("ArrowDown");
    const lf=S.keys.has("ArrowLeft"), rt=S.keys.has("ArrowRight");

    const calm = S.monk ? 0.86 : 1.0;
    const pIn = (up?1:0) + (dn?-1:0);
    const rIn = (rt?1:0) + (lf?-1:0);

    // subtle hands, strong forward
    const pitchTarget = pIn * 0.24 * calm;
    const rollTarget  = rIn * 0.34 * calm;

    S.pitch = lerp(S.pitch, pitchTarget, dt*7.8);
    S.roll  = lerp(S.roll,  rollTarget,  dt*7.8);

    const base=720, max=980, boostAdd=S.boost?360:0;
    S.targetSpeed = base + (max-base)*S.throttle + boostAdd;

    const resp = S.boost ? 3.0 : 1.8;
    S.speed += (S.targetSpeed - S.speed) * dt * resp;

    S.altitude += (S.pitch*3000 + (S.boost?240:0)) * dt;

    const turn = S.roll * (0.68 + (S.speed/980)) * calm;
    S.heading += (turn*52)*dt;

    // drift as camera sway
    S.driftX = lerp(S.driftX, S.roll*170, dt*2.6);
    S.driftY = lerp(S.driftY, -S.pitch*210, dt*2.6);

    const stress=(S.boost?0.38:0)+(Math.abs(S.roll)+Math.abs(S.pitch))*0.50;
    const recover=(S.monk?0.24:0.12);
    S.wattage = clamp(S.wattage + (recover-stress)*dt*0.34, 0,1);

    const steady = 1 - clamp(stress,0,1);
    S.signalClean = clamp(lerp(S.signalClean, steady, dt*0.60), 0,1);
  }

  function updateUI(){
    ui.hdg.textContent = fmt3(S.heading);
    ui.alt.textContent = fmtAlt(S.altitude);
    ui.spd.textContent = fmtSpd(S.speed);
    ui.bst.textContent = S.boost ? "ON" : "OFF";
    ui.navBadge.textContent = S.boost ? "BOOST" : (S.monk ? "MONK" : "NORM");

    ui.gates.textContent = String(S.gatesHit);
    ui.miss.textContent  = String(S.gatesMiss);
    ui.score.textContent = String(S.score).padStart(4,"0");

    let nearest=null; for (const g of gates){ if (!g.hit && (nearest===null || g.z<nearest)) nearest=g.z; }
    ui.range.textContent = nearest ? Math.round(nearest)+"m" : "—";

    ui.wattFill.style.width = Math.round(S.wattage*100)+"%";
    ui.wattBadge.textContent = S.wattage>0.75?"STEADY":(S.wattage>0.4?"WORKING":"LOW");
    ui.signal.textContent = S.signalClean>0.78?"CLEAN":(S.signalClean>0.45?"NOISY":"FRAY");
    ui.lock.textContent = "FORWARD";
    ui.msBadge.textContent = "FLOW";
  }

  let last=performance.now();
  function tick(now){
    S.dt=Math.min(0.033,(now-last)/1000);
    last=now; S.t+=S.dt;

    updateFlight(S.dt);
    const forward = clamp((S.speed/760)+(S.boost?0.78:0), 0.75, 2.55);
    updateGates(S.dt, forward);

    drawSky();
    drawFlow(S.dt, forward);
    drawGates();

    // cockpit + instruments
    drawAttitude();
    drawCockpit();

    updateUI();
    requestAnimationFrame(tick);
  }

  // seed a few gates
  spawnGate(); spawnGate();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
